<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Security - Auth Policy Prep | Red Hat | Public Sector</title>

    
    
    <link rel="stylesheet" href="/node_modules/patternfly/dist/css/patternfly.min.css" />
    <link rel="stylesheet" href="/node_modules/patternfly/dist/css/patternfly-additions.min.css" />

    
    <link rel="stylesheet" href="/node_modules/highlight.js/styles/darkula.css" />

    
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/asciidoc.css" />
    <link rel="stylesheet" href="/css/custom.css" />
    <link rel="stylesheet" href="/css/toastr.min.css" />

    
    <script id="adobe_dtm" src="//www.redhat.com/dtm.js" type="text/javascript"></script>

    
    <script src="/node_modules/patternfly/node_modules/jquery/dist/jquery.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/c3/c3.min.js"></script>
    <script src="/node_modules/patternfly/node_modules/d3/d3.min.js"></script>

    
    
    <script src="/node_modules/patternfly/node_modules/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="/node_modules/patternfly/node_modules/drmonty-datatables-colvis/js/dataTables.colVis.js"></script>
    <script src="/node_modules/patternfly/node_modules/datatables.net-colreorder/js/dataTables.colReorder.js"></script>

    
    
    <script src="/node_modules/patternfly/dist/js/patternfly.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/patternfly-bootstrap-combobox/js/bootstrap-combobox.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/moment/min/moment.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-select/dist/js/bootstrap-select.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-switch/dist/js/bootstrap-switch.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/patternfly-bootstrap-treeview/dist/bootstrap-treeview.min.js"></script>

    
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/jquery-match-height/dist/jquery.matchHeight-min.js"></script>
    
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/clip.js"></script>

    
    <script src="/js/toastr.min.js"></script>

    
    <script src="/node_modules/highlight.js/lib/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body class="">
    

<nav class="navbar navbar-default navbar-inverse navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
      <svg width=150 height=auto id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 613 145"><defs><style>.cls-1{fill:#e00;}.cls-2{fill:#fff;}</style></defs><path class="cls-1" d="M127.47,83.49c12.51,0,30.61-2.58,30.61-17.46a14,14,0,0,0-.31-3.42l-7.45-32.36c-1.72-7.12-3.23-10.35-15.73-16.6C124.89,8.69,103.76.5,97.51.5,91.69.5,90,8,83.06,8c-6.68,0-11.64-5.6-17.89-5.6-6,0-9.91,4.09-12.93,12.5,0,0-8.41,23.72-9.49,27.16A6.43,6.43,0,0,0,42.53,44c0,9.22,36.3,39.45,84.94,39.45M160,72.07c1.73,8.19,1.73,9.05,1.73,10.13,0,14-15.74,21.77-36.43,21.77C78.54,104,37.58,76.6,37.58,58.49a18.45,18.45,0,0,1,1.51-7.33C22.27,52,.5,55,.5,74.22c0,31.48,74.59,70.28,133.65,70.28,45.28,0,56.7-20.48,56.7-36.65,0-12.72-11-27.16-30.83-35.78"/><path d="M160,72.07c1.73,8.19,1.73,9.05,1.73,10.13,0,14-15.74,21.77-36.43,21.77C78.54,104,37.58,76.6,37.58,58.49a18.45,18.45,0,0,1,1.51-7.33l3.66-9.06A6.43,6.43,0,0,0,42.53,44c0,9.22,36.3,39.45,84.94,39.45,12.51,0,30.61-2.58,30.61-17.46a14,14,0,0,0-.31-3.42Z"/><path class="cls-2" d="M579.74,92.8c0,11.89,7.15,17.67,20.19,17.67a52.11,52.11,0,0,0,11.89-1.68V95a24.84,24.84,0,0,1-7.68,1.16c-5.37,0-7.36-1.68-7.36-6.73V68.3h15.56V54.1H596.78v-18l-17,3.68V54.1H568.49V68.3h11.25Zm-53,.32c0-3.68,3.69-5.47,9.26-5.47a43.12,43.12,0,0,1,10.1,1.26v7.15a21.51,21.51,0,0,1-10.63,2.63c-5.46,0-8.73-2.1-8.73-5.57m5.2,17.56c6,0,10.84-1.26,15.36-4.31v3.37h16.82V74.08c0-13.56-9.14-21-24.39-21-8.52,0-16.94,2-26,6.1l6.1,12.52c6.52-2.74,12-4.42,16.83-4.42,7,0,10.62,2.73,10.62,8.31v2.73a49.53,49.53,0,0,0-12.62-1.58c-14.31,0-22.93,6-22.93,16.73,0,9.78,7.78,17.24,20.19,17.24m-92.44-.94h18.09V80.92h30.29v28.82H506V36.12H487.93V64.41H457.64V36.12H439.55ZM370.62,81.87c0-8,6.31-14.1,14.62-14.1A17.22,17.22,0,0,1,397,72.09V91.54A16.36,16.36,0,0,1,385.24,96c-8.2,0-14.62-6.1-14.62-14.09m26.61,27.87h16.83V32.44l-17,3.68V57.05a28.3,28.3,0,0,0-14.2-3.68c-16.19,0-28.92,12.51-28.92,28.5a28.25,28.25,0,0,0,28.4,28.6,25.12,25.12,0,0,0,14.93-4.83ZM320,67c5.36,0,9.88,3.47,11.67,8.83H308.47C310.15,70.3,314.36,67,320,67M291.33,82c0,16.2,13.25,28.82,30.28,28.82,9.36,0,16.2-2.53,23.25-8.42l-11.26-10c-2.63,2.74-6.52,4.21-11.14,4.21a14.39,14.39,0,0,1-13.68-8.83h39.65V83.55c0-17.67-11.88-30.39-28.08-30.39a28.57,28.57,0,0,0-29,28.81M262,51.58c6,0,9.36,3.78,9.36,8.31S268,68.2,262,68.2H244.11V51.58Zm-36,58.16h18.09V82.92h13.77l13.89,26.82H292l-16.2-29.45a22.27,22.27,0,0,0,13.88-20.72c0-13.25-10.41-23.45-26-23.45H226Z"/></svg>
      </a>
    </div>
    <div class="collapse navbar-collapse navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        
        
          
            <li>
              <a href="/">Home</a>
            </li>
          
        
          
            <li>
              <a href="/about/">About</a>
            </li>
          
        
          
            <li>
              <a href="/contact/">Contact</a>
            </li>
          
        
          
            <li>
              <a href="https://www.redhat.com/en/events">Events</a>
            </li>
          
        
          
            <li>
              <a href="/jr-sa/">Junior SA Program</a>
            </li>
          
        
          
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Workshops <b class="caret"></b>
              </a>
              <ul class="dropdown-menu">
                
                  <li>
                    <a href="/workshops/agile_integrations_ci/">Agile Integrations Workshop - Citizen Integrator</a>
                  </li>
                
                  <li>
                    <a href="/workshops/agile_integrations_dev/">Agile Integrations Workshop - Developer</a>
                  </li>
                
                  <li>
                    <a href="/workshops/ansible_automation/">Ansible Automation Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/ansible_tower_azure/">Ansible Tower Workshop on Azure</a>
                  </li>
                
                  <li>
                    <a href="/workshops/cloudforms41/">CloudForms Workshops</a>
                  </li>
                
                  <li>
                    <a href="/workshops/security_containers/">Container Security Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/containers_101/">Containers 101 Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/secure_software_factory/">DevSecOps Workshop - Secure Software Factory</a>
                  </li>
                
                  <li>
                    <a href="/workshops/example/">Example Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/jdv_dev/">JBoss Data Virtualization Development</a>
                  </li>
                
                  <li>
                    <a href="/workshops/containers_the_hard_way/">Linux Containers the Hard Way</a>
                  </li>
                
                  <li>
                    <a href="/workshops/strangling_the_monolith/">Microservices Workshop - Strangling the Monolith</a>
                  </li>
                
                  <li>
                    <a href="/workshops/openshift_101_dcmetromap/">OpenShift 101 - DC Metro Map Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/openshift_4_101/">OpenShift 4 101</a>
                  </li>
                
                  <li>
                    <a href="/workshops/security_openshift/">OpenShift Security Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/openshift_service_mesh/">OpenShift Service Mesh</a>
                  </li>
                
                  <li>
                    <a href="/workshops/rhel_8/">Red Hat Enterprise Linux 8</a>
                  </li>
                
                  <li>
                    <a href="/workshops/rhosp_101/">Red Hat OpenStack Platform 101</a>
                  </li>
                
                  <li>
                    <a href="/workshops/selinux_policy/">SELinux Policy Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/source_to_image/">Source to Image</a>
                  </li>
                
              </ul>
            </li>
          
        
      </ul>
    </div>
  </div>
</nav>



<div class="jumbotron jumbotron-page text-center">
  <h1>Security - Auth Policy Prep</h1>
</div>

<div class="container">
  <div class="row">
    <p class="text-center">
      
      <a href="http://redhatgov.io/workshops/openshift_service_mesh">Return to Workshop</a>
    </p>
    
    







<nav>
  <ul class="pager">
    
      <li class="previous">
        <a href="http://redhatgov.io/workshops/openshift_service_mesh/lab5.2_verifymtls/">&larr; Previous: Security - Verifying mTLS</a>
      </li>
    
    
      <li class="next">
        <a href="http://redhatgov.io/workshops/openshift_service_mesh/lab5.4_authpolicy/">Next: Security - Auth Policy &rarr;</a>
      </li>
    
  </ul>
</nav>


    

<h1 id="single-sign-on">Single Sign-On</h1>

<p>Login, registration, and role-based authorization is handled via Red Hat SSO (aka Keycloak).
SSO is included as part of OpenShift or any middleware product subscription you have from Red Hat - woot!</p>

<h2 id="installation">Installation</h2>

<p>Because the service mesh will leverage SSO to authenticate users and generate JWT we need to install it. You will install it via Operator into your namespace.</p>

<h3 id="customize-the-resources">Customize the Resources</h3>

<p>Check out the .yaml files here and customize for this workshop cluster's domain, and your user project. Note that we have relaxed SSO security settings for the workshop and SSO config should be tightened up for production (e.g. things like CORS and the use of wildcards).</p>

<h3 id="create-an-instance-of-sso-configuration">Create an Instance of SSO / Configuration</h3>

<p>You can do this CLI or web console. If using web console just use the + button at the top then drag'n'drop the file from the steps below.</p>

<blockquote>
<i class="fa fa-terminal"></i> We create a Keycloak instance using a Kubernetes resource:
</blockquote>

<pre><code>oc apply -f ./istio-configuration/sso-keycloak.yaml
</code></pre>

<pre><code>oc patch cm/keycloak-probes -p '{&quot;data&quot;:{&quot;liveness_probe.sh&quot;:&quot;#!/bin/bash\necho pass\n&quot;,&quot;readiness_probe.sh&quot;:&quot;#!/bin/bash\necho pass\n&quot;}}'
</code></pre>

<blockquote>
<i class="fa fa-terminal"></i> Watch the pods for keycloak-0 to become READY 1/1:
</blockquote>

<pre><code>oc get pods keycloak-0 -w
</code></pre>

<pre><code>NAME                                       READY   STATUS      RESTARTS   AGE
keycloak-0                                 0/1     Pending       0          0s
keycloak-0                                 0/1     Init:0/1      0          0s
keycloak-0                                 0/1     Init:0/1      0          3s
keycloak-0                                 0/1     Init:0/1      0          4s
keycloak-0                                 0/1     PodInitializing   0          9s
keycloak-0                                 1/1     Running           0          10s
</code></pre>

<p><br></p>

<blockquote>
<i class="fa fa-terminal"></i> We configure via Kubernetes resources to create the realm + roles + clients & users as follows:
</blockquote>

<pre><code>sed &quot;s|http://istio-ingressgateway-istio-system.apps.cluster.domain.com|$GATEWAY_URL|&quot; ./istio-configuration/sso-realm.yaml | oc create -f -
</code></pre>

<pre><code>oc apply -f ./istio-configuration/sso-user1.yaml
</code></pre>

<pre><code>oc apply -f ./istio-configuration/sso-user2.yaml
</code></pre>

<h3 id="login-to-the-sso-admin-console">Login to the SSO Admin Console</h3>

<blockquote>
<i class="fa fa-terminal"></i>
Open the SSO console.  Retrieve the endpoint:
</blockquote>

<pre><code>SSO_CONSOLE=$(oc get route keycloak --template='https://{{.spec.host}}')
echo $SSO_CONSOLE
</code></pre>

<p>
<i class="fa fa-info-circle"></i>
Even after it's running keycloak will continue to initialize for a bit. If you are watching the pod logs you should see a line saying " Admin console listening on" which indicates it's ready for you to login.
</p>

<p><br>
Your admin username is <code>admin</code> and the password is autogenerated. These are in a secret called: <code>credential-workshop-keycloak</code></p>

<blockquote>
Choose one of the options below to find your password:
</blockquote>

<div class="panel-group">
  

<div class="panel panel-default">
  <div class="panel-heading">
    <h4 class="panel-title">
      
      <a data-toggle="collapse" href="#collapseb1c7192d29f7c3d71786d619b2efe5a3" class="collapsed">
      
        You can get the secret from the OpenShift web console (click to expand)
      </a>
    </h4>
  </div>
  
  <div id="collapseb1c7192d29f7c3d71786d619b2efe5a3" class="panel-collapse collapse ">
  
    <div class="panel-body">
       <blockquote>
<i class="fa fa-desktop"></i> In the Developer View, click to expand the "Advanced" dropdown
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Click "Project Details"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Scroll down a bit and click on "Secrets" from the Inventory panel
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Find the secret named "credential-workshop-keycloak" and click on it
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Scroll to the bottom and click the "Reveal Values" then copy the password
</blockquote>

    </div>
  </div>
</div>



<div class="panel panel-default">
  <div class="panel-heading">
    <h4 class="panel-title">
      
      <a data-toggle="collapse" href="#collapse74bf967dd078c4397bdf63d70d3b6bee" class="collapsed">
      
        Or you can get the secret with the CLI (click to expand)
      </a>
    </h4>
  </div>
  
  <div id="collapse74bf967dd078c4397bdf63d70d3b6bee" class="panel-collapse collapse ">
  
    <div class="panel-body">
       <blockquote>
<i class="fa fa-terminal"></i>
Run the following to print the secret out:
</blockquote>

<pre><code>oc get secret/credential-workshop-keycloak -o yaml
</code></pre>

<p>You'll see something like:</p>

<pre><code>apiVersion: v1
data:
  ADMIN_PASSWORD: SVZuM0pZQmNCeGl3bGc9PQ==
  ADMIN_USERNAME: YWRtaW4=
kind: Secret
</code></pre>

<blockquote>
From your output, copy the characters you see next to "ADMIN_PASSWORD: "
</blockquote>

<blockquote>
<i class="fa fa-terminal"></i>
Decode the characters by running (replace your copy):
</blockquote>

<pre><code>echo &lt;PASTE_YOUR_DATA_HERE&gt; | base64 -D
</code></pre>

<blockquote>
<i class="fa fa-terminal"></i>
Copy the password decoded
</blockquote>

    </div>
  </div>
</div>


</div>


<blockquote>
<i class="fa fa-desktop"></i> Goto the SSO web console and login as "admin" with the password you copied
</blockquote>

<p><br></p>

<h3 id="editing-config-with-the-sso-web-console">Editing Config with the SSO Web Console</h3>

<blockquote>
<i class="fa fa-desktop"></i> Now that you're logged in, click on "Users" and "View all users"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Select the "demo" user and goto "Credentials"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Set or Reset the password to "demo" (make sure the Temporary check box is set to "off")
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Repeat for the user "theterminator" and set the password to "illbeback"
</blockquote>

<p><br></p>

<h3 id="now-we-will-create-some-roles-for-our-users-in-the-sso-web-console">Now we will create some roles for our users in the SSO Web Console</h3>

<blockquote>
<i class="fa fa-desktop"></i> With the user "theterminator" still selected click "Role Mappings"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Click on the "cool-kids" role to highlight it. And click the "Add selected" button to give the role.
</blockquote>

<div class="panel-group">
  

<div class="panel panel-default">
  <div class="panel-heading">
    <h4 class="panel-title">
      
      <a data-toggle="collapse" href="#collapse9380bfbce936befbf6d3fc2fd7e7b140" class="collapsed">
      
        If you don&#39;t see cool-kids in the list (click to expand)
      </a>
    </h4>
  </div>
  
  <div id="collapse9380bfbce936befbf6d3fc2fd7e7b140" class="panel-collapse collapse ">
  
    <div class="panel-body">
       <blockquote>
<i class="fa fa-desktop"></i> On the left side bar click on "Roles" and "View all roles"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> On the right side of the screen click on "Add Role"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Type in "cool-kids" and a description, then click "Save"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Now go back to "Users" choose "theterminator" and you should be able to do the realm role mapping
</blockquote>

    </div>
  </div>
</div>


</div>


<p><br></p>

<h2 id="tell-the-app-ui-to-use-this-sso-service">Tell the APP UI to use this SSO service</h2>

<p>We had been faking login earlier to test our app without requiring SSO. Now let's get rid of that and redeploy the app_ui service.</p>

<blockquote>
<i class="fa fa-terminal"></i>
Type the following in the CLI:
</blockquote>

<pre><code>oc create route reencrypt keycloak-alt --service=keycloak 
</code></pre>

<pre><code>SSO_SVC=$(oc get route keycloak-alt --template='{{.spec.host}}')
oc set env dc/app-ui FAKE_USER=false SSO_SVC_HOST=$SSO_SVC
</code></pre>

<p><br/></p>

<h2 id="access-info-api-documentation">Access Info / API documentation</h2>

<ul>
<li>Admin can login at: <a href="https://keycloak-userX.apps.YOURCLUSTER.COM/">https://keycloak-userX.apps.YOURCLUSTER.COM/</a></li>
<li>Users will login at: <a href="https://keycloak-userX.apps.YOURCLUSTER.COM/auth/realms/microservices/account">https://keycloak-userX.apps.YOURCLUSTER.COM/auth/realms/microservices/account</a></li>
<li>To understand more about keycloak check out the resources below:

<ul>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.3/html-single/red_hat_single_sign-on_for_openshift/">Official Docs</a></li>
<li><a href="https://www.keycloak.org/documentation.html">Upstream Docs</a></li>
<li><a href="https://developers.redhat.com/blog/2020/01/29/api-login-and-jwt-token-generation-using-keycloak/">Blog Example</a></li>
</ul></li>
</ul>

<p><br/></p>


    







<nav>
  <ul class="pager">
    
      <li class="previous">
        <a href="http://redhatgov.io/workshops/openshift_service_mesh/lab5.2_verifymtls/">&larr; Previous: Security - Verifying mTLS</a>
      </li>
    
    
      <li class="next">
        <a href="http://redhatgov.io/workshops/openshift_service_mesh/lab5.4_authpolicy/">Next: Security - Auth Policy &rarr;</a>
      </li>
    
  </ul>
</nav>


    <p class="text-center">
      
      <a href="http://redhatgov.io/workshops/openshift_service_mesh">Return to Workshop</a>
    </p>
  </div>
</div>

    <div id="page-footer" class="container">
      <p class="text-center">
        Copyright &copy; 2020 Red Hat, Inc.
      </p>
    </div>
    <script type="text/javascript">
      if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
          _satellite.pageBottom();
      }
    </script>
  </body>
</html>

